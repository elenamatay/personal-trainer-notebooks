# This file is meant to be run inside lldb
# It registers command to load library and invoke attach function
# Also it marks process threads to to distinguish them from debugger
# threads later while settings trace in threads

<<<<<<< HEAD

def load_lib_and_attach(debugger, command, result, internal_dict):
    import shlex

=======
def load_lib_and_attach(debugger, command, result, internal_dict):
    import shlex
>>>>>>> 18d7037cf30f05fb9c835180cb251f94a7f2d64c
    args = shlex.split(command)

    dll = args[0]
    is_debug = args[1]
    python_code = args[2]
    show_debug_info = args[3]

    import lldb
<<<<<<< HEAD

=======
>>>>>>> 18d7037cf30f05fb9c835180cb251f94a7f2d64c
    options = lldb.SBExpressionOptions()
    options.SetFetchDynamicValue()
    options.SetTryAllThreads(run_others=False)
    options.SetTimeoutInMicroSeconds(timeout=10000000)

    print(dll)
    target = debugger.GetSelectedTarget()
<<<<<<< HEAD
    res = target.EvaluateExpression('(void*)dlopen("%s", 2);' % (dll), options)
=======
    res = target.EvaluateExpression("(void*)dlopen(\"%s\", 2);" % (
        dll), options)
>>>>>>> 18d7037cf30f05fb9c835180cb251f94a7f2d64c
    error = res.GetError()
    if error:
        print(error)

    print(python_code)
<<<<<<< HEAD
    res = target.EvaluateExpression('(int)DoAttach(%s, "%s", %s);' % (is_debug, python_code.replace('"', "'"), show_debug_info), options)
=======
    res = target.EvaluateExpression("(int)DoAttach(%s, \"%s\", %s);" % (
        is_debug, python_code.replace('"', "'"), show_debug_info), options)
>>>>>>> 18d7037cf30f05fb9c835180cb251f94a7f2d64c
    error = res.GetError()
    if error:
        print(error)

<<<<<<< HEAD

def __lldb_init_module(debugger, internal_dict):
    import lldb

    debugger.HandleCommand("command script add -f lldb_prepare.load_lib_and_attach load_lib_and_attach")
=======
def __lldb_init_module(debugger, internal_dict):
    import lldb

    debugger.HandleCommand('command script add -f lldb_prepare.load_lib_and_attach load_lib_and_attach')
>>>>>>> 18d7037cf30f05fb9c835180cb251f94a7f2d64c

    try:
        target = debugger.GetSelectedTarget()
        if target:
            process = target.GetProcess()
            if process:
                for thread in process:
                    # print('Marking process thread %d'%thread.GetThreadID())
<<<<<<< HEAD
                    internal_dict["_thread_%d" % thread.GetThreadID()] = True
                    # thread.Suspend()
    except:
        import traceback

        traceback.print_exc()
=======
                    internal_dict['_thread_%d' % thread.GetThreadID()] = True
                    # thread.Suspend()
    except:
        import traceback;traceback.print_exc()



>>>>>>> 18d7037cf30f05fb9c835180cb251f94a7f2d64c
